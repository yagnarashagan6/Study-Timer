<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aether Memory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      /* --- 1. Setup & Variables --- */
      :root {
        --color-bg-start: #0b1020;
        --color-bg-end: #2a2f66;
        --color-accent-coral: #ff6b6b;
        --color-highlight-gold: #ffd27f;
        --color-secondary-teal: #4de1d7;
        --font-ui: "Inter", sans-serif;
        --font-title: "Playfair Display", serif;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-ui);
        background: linear-gradient(
          145deg,
          var(--color-bg-start),
          var(--color-bg-end)
        );
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        overflow: auto;
        perspective: 1200px;
      }

      /* Iframe compatibility */
      @media (max-height: 600px) {
        body {
          min-height: 600px;
          overflow-y: auto;
        }
      }

      /* When inside iframe */
      body.iframe-mode {
        min-height: 100%;
        height: 100%;
        overflow: auto;
        padding: 20px 10px;
        padding-top: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      body.iframe-mode .memory-board {
        max-width: 95%;
        max-height: calc(100vh - 200px);
      }

      body.iframe-mode .screen {
        margin-top: 40px;
        padding-top: 20px;
        position: relative;
        top: auto;
        left: auto;
        height: auto;
        min-height: calc(100vh - 100px);
        justify-content: center;
        align-items: center;
      }

      body.iframe-mode #game-screen {
        margin-top: 30px;
        padding-top: 20px;
        gap: 25px;
      }

      body.iframe-mode #start-screen {
        margin-top: 30px;
        padding-top: 20px;
      }

      body.iframe-mode #game-board {
        margin-top: 10px;
      }

      /* Mobile responsive adjustments for iframe */
      @media (max-width: 768px) {
        body.iframe-mode {
          padding-top: 40px;
          padding: 15px 10px;
        }

        body.iframe-mode .screen {
          margin-top: 30px;
          padding-top: 15px;
          min-height: calc(100vh - 80px);
        }

        body.iframe-mode #game-screen {
          margin-top: 25px;
          gap: 15px;
          padding-top: 15px;
        }

        body.iframe-mode #start-screen {
          margin-top: 25px;
          padding-top: 15px;
        }

        body.iframe-mode .memory-board {
          max-width: 90%;
          max-height: calc(100vh - 180px);
        }
      }

      /* --- 2. Screen Management --- */
      .screen {
        display: none;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 20px;
        animation: fadeIn 0.5s ease-out;
      }

      .screen.active {
        display: flex;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* --- 3. Start Menu Screen --- */
      #start-screen .title {
        font-family: var(--font-title);
        font-size: clamp(3rem, 10vw, 5rem);
        letter-spacing: 2px;
        text-shadow: 0 0 15px rgba(255, 210, 127, 0.4);
        margin-bottom: 40px;
      }

      .menu-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
        max-width: 300px;
      }

      /* Glassmorphism Button Style */
      .btn {
        font-family: var(--font-ui);
        font-size: 1rem;
        font-weight: 600;
        padding: 15px 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1),
          inset 0 1px 1px rgba(255, 255, 255, 0.1);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15),
          inset 0 1px 1px rgba(255, 255, 255, 0.1);
      }

      /* --- 4. Game Screen --- */
      #game-screen {
        gap: 30px;
      }

      .hud {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        width: 100%;
        max-width: 700px;
      }

      #stats-display {
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        gap: 30px;
      }

      .game-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      #game-board {
        display: grid;
        gap: 10px;
        width: clamp(300px, 90vw, 700px);
        grid-template-columns: repeat(var(--grid-cols, 4), 1fr);
        grid-template-rows: repeat(var(--grid-rows, 2), 1fr);
      }

      /* Card Styles */
      .card {
        background-color: transparent;
        cursor: pointer;
        perspective: 1000px;
        aspect-ratio: 1 / 1; /* This ensures all cards are square */
      }

      .card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        border-radius: 15px;
      }

      .card.flipped .card-inner {
        transform: rotateY(180deg);
      }

      .card.matched {
        opacity: 0.5;
        cursor: default;
      }

      .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 15px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }

      .card-front {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
      }

      .card-front:hover {
        background: rgba(77, 225, 215, 0.2); /* Teal hover */
      }

      .card-back {
        background: rgba(255, 255, 255, 0.08);
        transform: rotateY(180deg);
        padding: 15%;
      }

      .card-back .icon-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 8px;
        text-align: center;
      }

      .card-back img {
        max-width: 70%;
        max-height: 70%;
        object-fit: contain;
      }

      .card-back .icon-label {
        font-size: 0.7em;
        color: #fff;
      }

      .card-back i {
        font-size: 3.5em;
        line-height: 1;
      }

      .card-back svg {
        width: 100%;
        height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
      }

      /* --- 5. Result Modal --- */
      #result-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 100;
        display: none; /* Initially hidden */
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s;
      }

      .modal-content {
        background: linear-gradient(
          145deg,
          var(--color-bg-end),
          var(--color-bg-start)
        );
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      #result-message {
        font-family: var(--font-title);
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      #result-detail {
        font-size: 1.2rem;
        margin-bottom: 30px;
        opacity: 0.9;
      }

      .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      /* --- 6. Responsive Design --- */
      @media (max-width: 600px) and (orientation: portrait) {
        body {
          overflow: hidden; /* No scrolling needed - fit everything on screen */
          align-items: center;
        }

        .screen {
          height: 100vh;
          padding: 10px;
          overflow: hidden;
        }

        #game-screen {
          gap: 10px;
          height: 100vh;
          justify-content: center;
          padding: 10px 10px 20px 10px;
        }

        .hud {
          gap: 8px;
          flex-shrink: 0;
        }

        #stats-display {
          font-size: 0.85rem;
          gap: 12px;
          flex-wrap: wrap;
          justify-content: center;
        }

        .game-buttons {
          gap: 8px;
        }

        .game-buttons .btn {
          padding: 8px 12px;
          font-size: 0.85rem;
        }

        .card {
          min-height: 0;
        }

        .card-back {
          padding: 8%;
        }

        .card-back i {
          font-size: 2em;
        }

        .card-back img {
          max-width: 60%;
          max-height: 60%;
        }

        .card-back .icon-label {
          font-size: 0.6em;
        }

        .card-inner {
          border-radius: 8px;
        }

        .card-face {
          border-radius: 8px;
        }

        .modal-content {
          padding: 30px 20px;
          max-width: 350px;
        }

        #result-message {
          font-size: 2rem;
        }

        #result-detail {
          font-size: 1rem;
        }

        .modal-buttons {
          flex-direction: column;
          width: 100%;
        }

        .modal-buttons .btn {
          width: 100%;
          padding: 12px 15px;
        }

        #start-screen .title {
          font-size: clamp(2.5rem, 8vw, 3.5rem);
          margin-bottom: 30px;
        }

        .menu-buttons {
          max-width: 280px;
        }

        .menu-buttons .btn {
          padding: 12px 18px;
          font-size: 0.95rem;
        }
      }

      /* Additional responsive support for landscape mobile */
      @media (max-width: 900px) and (orientation: landscape) {
        #game-screen {
          gap: 8px;
          padding: 5px 10px;
        }

        .hud {
          gap: 8px;
        }

        #stats-display {
          font-size: 0.85rem;
          gap: 15px;
        }

        .game-buttons .btn {
          padding: 6px 10px;
          font-size: 0.85rem;
        }

        .card-back i {
          font-size: 2.2em;
        }

        .card-back img {
          max-width: 65%;
          max-height: 65%;
        }

        .card-back .icon-label {
          font-size: 0.6em;
        }

        .card-back {
          padding: 10%;
        }
      }
    </style>
  </head>
  <body>
    <div id="start-screen" class="screen active">
      <h1 class="title">Aether Memory</h1>
      <div class="menu-buttons"></div>
    </div>

    <div id="game-screen" class="screen">
      <div class="hud">
        <div id="stats-display">
          <span id="moves-count">Moves: 0</span>
          <span id="pairs-found">Pairs: 0 / 0</span>
        </div>
        <div class="game-buttons">
          <button id="restart-btn" class="btn">Restart</button>
          <button id="menu-btn" class="btn">Menu</button>
        </div>
      </div>
      <div id="game-board"></div>
    </div>

    <div id="result-modal">
      <div class="modal-content">
        <h2 id="result-message">Victory!</h2>
        <p id="result-detail">You completed the level in 42 moves.</p>
        <div class="modal-buttons">
          <button id="replay-btn" class="btn">Replay</button>
          <button id="next-level-btn" class="btn">Next Level</button>
          <button id="modal-menu-btn" class="btn">Main Menu</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Detect if running in iframe and adjust styling
        if (window.self !== window.top) {
          document.body.classList.add("iframe-mode");
        }

        // --- 1. DOM Elements & State Variables ---
        const startScreen = document.getElementById("start-screen");
        const gameScreen = document.getElementById("game-screen");
        const boardElement = document.getElementById("game-board");
        const resultModal = document.getElementById("result-modal");

        const movesCountSpan = document.getElementById("moves-count");
        const pairsFoundSpan = document.getElementById("pairs-found");
        const resultMessage = document.getElementById("result-message");
        const resultDetail = document.getElementById("result-detail");
        const menuButtonsContainer = document.querySelector(".menu-buttons");
        const nextLevelBtn = document.getElementById("next-level-btn");

        // --- State ---
        let currentLevelIndex = 0;
        let cards = [];
        let flippedCards = [];
        let matchedPairsCount = 0;
        let totalPairs = 0;
        let moveCount = 0;
        let isBoardLocked = false;

        const createIconHTML = (content, label) => `
            <div class="icon-container">
                ${content}
                <span class="icon-label">${label}</span>
            </div>`;

        // --- Sound Effects ---
        const sounds = {
          flip: new Audio(
            "data:audio/wav;base64,UklGRiwAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhBwAAAD/8E/z0/FL9Cf3r/Fr+vP6l/En/c/9F/23/V/9T/2H/eP+G/5b/qf+1/77/wv/I/8z/0P/U/9f/2P/Z/9r/2v/a/9r/2v/Z/9j/1//V/9P/z//M/8j/w//A/7n/s/+n/6L/k/+B/3j/a/9V/0v/Qf98/2L/Wf8="
          ),
          match: new Audio(
            "data:audio/wav;base64,UklGRiIGAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAAAAAAsA/v/V/9f/wf/K/8X/w//C/8L/w//D/8T/yv/Q/9b/3P/g/+T/7f/y//f/AgAEAAwADgAOAAoACQAHAAUAAwABAAAAAP//9f/s/9//AgABAAMABQAHAAgACgAOAA4ADAAAAAD//w=="
          ),
          win: new Audio(
            "data:audio/wav;base64,UklGRjwAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhJAAAACv/Qf9f/2T/b/9x/3L/cv9v/2n/Y/9b/1j/XP9j/2f/b/91/3n/ff+C/4b/if+M/4//mv+f/6T/pv+p/6r/qv+p/6f/nv+a/4//jP+I/4D/ev9z/2z/Zf9c/1T/Uv9T/1T/VQ=="
          ),
          click: new Audio(
            "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"
          ),
        };

        // --- Data ---
        const techIcons = {
          chatbot: createIconHTML(
            `<img src="logo/icons8-chatbot-50.png" />`,
            "Chatbot"
          ),
          claude: createIconHTML(`<img src="logo/claude.png" />`, "Claude"),
          dart: createIconHTML(
            `<img src="logo/icons8-dart-480.png" />`,
            "Dart"
          ),
          deepseek: createIconHTML(
            `<img src="logo/icons8-deepseek-480.png" />`,
            "DeepSeek"
          ),
          gemini: createIconHTML(`<img src="logo/gemini.png" />`, "Gemini"),
          grok: createIconHTML(
            `<img src="logo/icons8-grok-150.png" />`,
            "Grok"
          ),
          kotlin: createIconHTML(
            `<img src="logo/icons8-kotlin-480.png" />`,
            "Kotlin"
          ),
          lua: createIconHTML(
            `<img src="logo/icons8-lua-language-480.png" />`,
            "Lua"
          ),
          matlab: createIconHTML(
            `<img src="logo/icons8-matlab-50.png" />`,
            "MATLAB"
          ),
          ruby: createIconHTML(
            `<img src="logo/icons8-ruby-programming-language-480.png" />`,
            "Ruby"
          ),
          rust: createIconHTML(
            `<img src="logo/icons8-rust-programming-language-480.png" />`,
            "Rust"
          ),
          javascript: createIconHTML(
            `<i class="fab fa-js-square" style="color: #f7df1e;"></i>`,
            "JavaScript"
          ),
          bash: createIconHTML(
            `<i class="fas fa-terminal" style="color: #4eaa25;"></i>`,
            "Bash/Shell"
          ),
          html: createIconHTML(
            `<i class="fab fa-html5" style="color: #e34f26;"></i>`,
            "HTML/CSS"
          ),
          java: createIconHTML(
            `<i class="fab fa-java" style="color: #ed8b00;"></i>`,
            "Java"
          ),
          python: createIconHTML(
            `<i class="fab fa-python" style="color: #3776ab;"></i>`,
            "Python"
          ),
          c: createIconHTML(
            `<i class="fas fa-c" style="color: #00599c;"></i>`,
            "C"
          ),
          cpp: createIconHTML(
            `<i class="fas fa-copyright" style="color: #00599c;"></i>`,
            "C++"
          ),
          csharp: createIconHTML(
            `<i class="fas fa-hashtag" style="font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #512bd4;">C</i>`,
            "C#"
          ),
          sql: createIconHTML(
            `<i class="fas fa-database" style="color: #336791;"></i>`,
            "SQL"
          ),
          php: createIconHTML(
            `<i class="fab fa-php" style="color: #777bb4;"></i>`,
            "PHP"
          ),
          typescript: createIconHTML(
            `<i class="fab fa-js-square" style="color: #3178c6;"></i>`,
            "TypeScript"
          ),
          powershell: createIconHTML(
            `<i class="fas fa-terminal" style="color: #0078d4;"></i>`,
            "PowerShell"
          ),
          swift: createIconHTML(
            `<i class="fab fa-swift" style="color: #f05138;"></i>`,
            "Swift"
          ),
          go: createIconHTML(
            `<i class="fab fa-golang" style="color: #00add8;"></i>`,
            "Go"
          ),
          angular: createIconHTML(
            `<i class="fab fa-angular" style="color: #dd0031;"></i>`,
            "Angular"
          ),
        };

        const levelConfigs = [
          { name: "Level 1", rows: 2, cols: 4, pairs: 4 },
          { name: "Level 2", rows: 3, cols: 4, pairs: 6 },
          { name: "Level 3", rows: 4, cols: 4, pairs: 8 },
          { name: "Level 4", rows: 4, cols: 5, pairs: 10 },
          { name: "Level 5", rows: 4, cols: 6, pairs: 12 },
          { name: "Level 6", rows: 4, cols: 7, pairs: 14 },
        ];

        // --- 2. Game Setup & Transitions ---

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
        }

        function populateStartMenu() {
          menuButtonsContainer.innerHTML = "";
          levelConfigs.forEach((level, index) => {
            const button = document.createElement("button");
            button.className = "btn";
            button.dataset.levelIndex = index;
            button.textContent = `${level.name} (${level.cols}x${level.rows})`;
            menuButtonsContainer.appendChild(button);
          });
        }

        function showScreen(screenId) {
          document
            .querySelectorAll(".screen")
            .forEach((s) => s.classList.remove("active"));
          document.getElementById(screenId).classList.add("active");
        }

        // MODIFIED startGame Function
        function startGame(levelIndex) {
          currentLevelIndex = levelIndex;
          // Make a mutable copy of the config to allow for overrides
          let config = { ...levelConfigs[levelIndex] };

          const isMobile = window.matchMedia("(max-width: 600px)").matches;
          const isPortrait = window.matchMedia(
            "(orientation: portrait)"
          ).matches;

          // --- Mobile-specific level adjustments ---
          if (isMobile) {
            if (levelIndex === 0) {
              // Level 1 Mobile: 2x3 grid
              config.rows = 2;
              config.cols = 3;
              config.pairs = 3;
            }
            if (levelIndex === 1) {
              // Level 2 Mobile: 4x3
              // A 3x3 grid is impossible for a pairs game (odd number).
              // A 4x3 grid provides a good mobile layout with 6 pairs.
              config.rows = 4;
              config.cols = 3;
              config.pairs = 6;
            }
            if (levelIndex === 3) {
              // Level 4 Mobile: Keep original 5x4 (5 rows, 4 cols)
              config.rows = 5;
              config.cols = 4;
              config.pairs = 10;
            }
            if (levelIndex === 4) {
              // Level 5 Mobile: Keep original 6x4 (6 rows, 4 cols)
              config.rows = 6;
              config.cols = 4;
              config.pairs = 12;
            }
            if (levelIndex === 5) {
              // Level 6 Mobile: Keep original 7x4 (7 rows, 4 cols)
              config.rows = 7;
              config.cols = 4;
              config.pairs = 14;
            }
          }

          totalPairs = config.pairs;

          // Reset state
          matchedPairsCount = 0;
          moveCount = 0;
          flippedCards = [];
          isBoardLocked = false;
          boardElement.innerHTML = "";

          // --- Dynamic Sizing Logic for Mobile & Laptop ---
          let gap = isMobile ? 8 : 10;

          // Adjust reserved space for HUD to give board more room
          let reserved = isMobile && isPortrait ? 150 : isMobile ? 120 : 180;

          let availableHeight = window.innerHeight - reserved;
          let vwFactor = 0.95; // Use 95% of viewport width for more screen coverage
          let availableWidth = window.innerWidth * vwFactor;

          let maxBoardW;
          // For higher levels on desktop, let the board fill the screen.
          if (!isMobile && levelIndex >= 3) {
            maxBoardW = availableWidth;
          } else {
            // For other cases, use previous logic with a cap.
            maxBoardW = Math.max(300, Math.min(availableWidth, 700));
          }

          let rows = config.rows;
          let cols = config.cols;

          let cellW = (maxBoardW - gap * (cols - 1)) / cols;
          let cellH = (availableHeight - gap * (rows - 1)) / rows;
          let cellSide = Math.min(cellW, cellH);
          let boardW = cols * cellSide + gap * (cols - 1);
          let boardH = rows * cellSide + gap * (rows - 1);

          boardElement.style.setProperty("--grid-cols", cols);
          boardElement.style.setProperty("--grid-rows", rows);
          boardElement.style.gap = `${gap}px`;
          boardElement.style.width = `${boardW}px`;
          boardElement.style.height = `${boardH}px`;

          // Prepare cards: Shuffle all icons, then pick the number needed
          const availableIcons = Object.keys(techIcons);
          shuffleArray(availableIcons);
          const iconsForLevel = availableIcons.slice(0, totalPairs);
          const cardData = [...iconsForLevel, ...iconsForLevel];
          shuffleArray(cardData);

          createBoard(cardData);
          updateStats();
          showScreen("game-screen");
          sounds.click.play();
        }

        function createBoard(cardData) {
          cardData.forEach((name) => {
            const card = document.createElement("div");
            card.classList.add("card");
            card.dataset.name = name;

            card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-face card-front"></div>
                        <div class="card-face card-back">${techIcons[name]}</div>
                    </div>
                `;
            boardElement.appendChild(card);
          });
        }

        // --- 3. Core Gameplay Logic ---
        function handleCardClick(e) {
          const card = e.target.closest(".card");

          if (
            !card ||
            isBoardLocked ||
            card.classList.contains("flipped") ||
            card.classList.contains("matched")
          ) {
            return;
          }

          flipCard(card);

          if (flippedCards.length === 2) {
            isBoardLocked = true;
            moveCount++;
            updateStats();
            setTimeout(checkForMatch, 1000);
          }
        }

        function flipCard(card) {
          sounds.flip.play();
          card.classList.add("flipped");
          flippedCards.push(card);
        }

        function checkForMatch() {
          const [card1, card2] = flippedCards;
          const isMatch = card1.dataset.name === card2.dataset.name;

          if (isMatch) {
            handleMatch();
          } else {
            unflipCards();
          }
        }

        function handleMatch() {
          sounds.match.play();
          flippedCards.forEach((card) => card.classList.add("matched"));
          matchedPairsCount++;
          updateStats();
          resetFlipped();

          if (matchedPairsCount === totalPairs) {
            endGame();
          }
        }

        function unflipCards() {
          flippedCards.forEach((card) => card.classList.remove("flipped"));
          resetFlipped();
        }

        function resetFlipped() {
          flippedCards = [];
          isBoardLocked = false;
        }

        function endGame() {
          sounds.win.play();
          confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
          setTimeout(() => showResultModal(), 1000);
        }

        // --- 4. UI & Display ---
        function updateStats() {
          movesCountSpan.textContent = `Moves: ${moveCount}`;
          pairsFoundSpan.textContent = `Pairs: ${matchedPairsCount} / ${totalPairs}`;
        }

        function showResultModal() {
          resultMessage.textContent = "Victory!";
          resultDetail.textContent = `You found all pairs in ${moveCount} moves.`;

          // Show or hide the "Next Level" button
          if (currentLevelIndex < levelConfigs.length - 1) {
            nextLevelBtn.style.display = "inline-block";
          } else {
            nextLevelBtn.style.display = "none";
          }

          resultModal.style.display = "flex";
        }

        function hideResultModal() {
          resultModal.style.display = "none";
        }

        // --- 5. Event Listeners ---
        menuButtonsContainer.addEventListener("click", (e) => {
          const levelIndex = e.target.dataset.levelIndex;
          if (levelIndex) {
            startGame(parseInt(levelIndex));
          }
        });

        boardElement.addEventListener("click", handleCardClick);

        document.getElementById("replay-btn").addEventListener("click", () => {
          hideResultModal();
          startGame(currentLevelIndex);
          sounds.click.play();
        });

        nextLevelBtn.addEventListener("click", () => {
          hideResultModal();
          if (currentLevelIndex < levelConfigs.length - 1) {
            startGame(currentLevelIndex + 1);
          }
          sounds.click.play();
        });

        document.getElementById("restart-btn").addEventListener("click", () => {
          startGame(currentLevelIndex);
          sounds.click.play();
        });

        document
          .getElementById("modal-menu-btn")
          .addEventListener("click", () => {
            hideResultModal();
            showScreen("start-screen");
            sounds.click.play();
          });

        document.getElementById("menu-btn").addEventListener("click", () => {
          showScreen("start-screen");
          sounds.click.play();
        });

        // --- Initial Setup ---
        populateStartMenu();
      });
    </script>
  </body>
</html>
